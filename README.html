<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepSeek V3 å®Œæ•´è®­ç»ƒæŒ‡å—</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-light: #3b82f6;
            --primary-dark: #1d4ed8;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-color: #334155;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --code-bg: #1e293b;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --info-color: #06b6d4;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            line-height: 1.7;
            font-size: 16px;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 60px 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .header h1 {
            font-size: 2.8em;
            margin-bottom: 15px;
            position: relative;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .header .tagline {
            font-size: 1.2em;
            opacity: 0.95;
            position: relative;
            max-width: 700px;
            margin: 0 auto;
            background: rgba(255,255,255,0.1);
            padding: 15px 25px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .header .tagline strong {
            color: #fbbf24;
        }

        /* Navigation */
        .nav-container {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--card-bg);
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border-bottom: 1px solid var(--border-color);
        }

        .nav-toggle {
            display: none;
            padding: 15px 20px;
            cursor: pointer;
            font-weight: 600;
            color: var(--primary-color);
        }

        .toc {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px 20px;
        }

        .toc h2 {
            display: none;
        }

        .toc ol {
            display: flex;
            flex-wrap: wrap;
            gap: 5px 20px;
            list-style: none;
            justify-content: center;
        }

        .toc li {
            position: relative;
        }

        .toc a {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9em;
            padding: 5px 10px;
            border-radius: 5px;
            transition: all 0.2s;
            display: inline-block;
        }

        .toc a:hover {
            color: var(--primary-color);
            background: rgba(37, 99, 235, 0.1);
        }

        /* Main Content */
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .section {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 35px 40px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
        }

        h2 {
            color: var(--primary-dark);
            font-size: 1.8em;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--primary-color);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        h2::before {
            content: 'Â§';
            color: var(--primary-light);
            font-weight: normal;
        }

        h3 {
            color: var(--text-color);
            font-size: 1.4em;
            margin: 30px 0 15px;
            padding-left: 15px;
            border-left: 4px solid var(--primary-light);
        }

        h4 {
            color: var(--text-secondary);
            font-size: 1.15em;
            margin: 25px 0 12px;
            font-weight: 600;
        }

        p {
            margin-bottom: 15px;
            color: var(--text-color);
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            margin: 20px 0;
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95em;
        }

        th {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
            color: white;
            padding: 14px 16px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:nth-child(even) {
            background: #f8fafc;
        }

        tr:hover {
            background: rgba(37, 99, 235, 0.05);
        }

        /* Code Blocks */
        pre {
            background: var(--code-bg);
            border-radius: 10px;
            padding: 20px;
            overflow-x: auto;
            margin: 15px 0;
            border: 1px solid #334155;
        }

        pre code {
            color: #e2e8f0;
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }

        code {
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
            background: #f1f5f9;
            color: #be185d;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        pre code {
            background: transparent;
            color: #e2e8f0;
            padding: 0;
        }

        /* Syntax Highlighting */
        .keyword { color: #c084fc; }
        .string { color: #86efac; }
        .comment { color: #64748b; font-style: italic; }
        .function { color: #60a5fa; }
        .number { color: #fbbf24; }
        .operator { color: #f472b6; }

        /* Lists */
        ul, ol {
            margin: 15px 0;
            padding-left: 25px;
        }

        li {
            margin: 8px 0;
        }

        /* Blockquote */
        blockquote {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.1) 0%, rgba(59, 130, 246, 0.05) 100%);
            border-left: 4px solid var(--primary-color);
            padding: 20px 25px;
            margin: 20px 0;
            border-radius: 0 10px 10px 0;
            font-style: italic;
        }

        blockquote strong {
            color: var(--primary-dark);
        }

        /* Info Boxes */
        .info-box {
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }

        .info-box.success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .info-box.warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .info-box.info {
            background: rgba(6, 182, 212, 0.1);
            border: 1px solid rgba(6, 182, 212, 0.3);
        }

        /* Features List */
        .features-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .feature-item {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .feature-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .feature-item strong {
            color: var(--primary-color);
            display: block;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        /* File Tree */
        .file-tree {
            background: var(--code-bg);
            border-radius: 10px;
            padding: 20px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
            line-height: 1.8;
            color: #e2e8f0;
        }

        .file-tree .folder {
            color: #60a5fa;
        }

        .file-tree .file {
            color: #86efac;
        }

        .file-tree .comment {
            color: #64748b;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge.online {
            background: rgba(16, 185, 129, 0.15);
            color: #059669;
        }

        .badge.offline {
            background: rgba(245, 158, 11, 0.15);
            color: #d97706;
        }

        /* Log Levels */
        .log-levels {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .log-level {
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
        }

        .log-level.debug {
            background: rgba(6, 182, 212, 0.15);
            color: #0891b2;
        }

        .log-level.info {
            background: rgba(16, 185, 129, 0.15);
            color: #059669;
        }

        .log-level.warning {
            background: rgba(245, 158, 11, 0.15);
            color: #d97706;
        }

        .log-level.error {
            background: rgba(239, 68, 68, 0.15);
            color: #dc2626;
        }

        .log-level.critical {
            background: rgba(239, 68, 68, 0.25);
            color: #b91c1c;
            font-weight: 700;
        }

        /* Horizontal Rule */
        hr {
            border: none;
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, var(--border-color) 50%, transparent 100%);
            margin: 40px 0;
        }

        /* Links */
        a {
            color: var(--primary-color);
            text-decoration: none;
            transition: color 0.2s;
        }

        a:hover {
            color: var(--primary-dark);
            text-decoration: underline;
        }

        /* Formula Box */
        .formula {
            background: #fefce8;
            border: 1px solid #fef08a;
            border-radius: 8px;
            padding: 15px 20px;
            margin: 15px 0;
            font-family: 'Times New Roman', serif;
            font-size: 1.05em;
            overflow-x: auto;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 40px 20px;
            background: var(--code-bg);
            color: #94a3b8;
            margin-top: 40px;
        }

        .footer a {
            color: #60a5fa;
        }

        .footer .links {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .footer .links a {
            background: rgba(255,255,255,0.1);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            transition: background 0.2s;
        }

        .footer .links a:hover {
            background: rgba(255,255,255,0.2);
            text-decoration: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }

            .section {
                padding: 25px 20px;
            }

            h2 {
                font-size: 1.5em;
            }

            .toc ol {
                flex-direction: column;
                gap: 5px;
            }

            .nav-toggle {
                display: block;
            }

            .toc.collapsed ol {
                display: none;
            }
        }

        /* Scroll to top button */
        .scroll-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            font-size: 1.2em;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
        }

        .scroll-top.visible {
            opacity: 1;
        }

        .scroll-top:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>ğŸš€ DeepSeek V3 å®Œæ•´è®­ç»ƒæŒ‡å—</h1>
        <p class="tagline">æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªæ•™è‚²æ€§çš„ DeepSeek V3 å®ç°ï¼Œæ¶µç›– <strong>Pretrain â†’ SFT â†’ RL</strong> å®Œæ•´è®­ç»ƒæµç¨‹ã€‚</p>
    </header>

    <nav class="nav-container">
        <div class="nav-toggle" onclick="toggleNav()">ğŸ“– ç›®å½•å¯¼èˆª â–¼</div>
        <div class="toc" id="toc">
            <ol>
                <li><a href="#section-1">1. é¡¹ç›®æ¦‚è¿°</a></li>
                <li><a href="#section-2">2. æ¶æ„è®¾è®¡</a></li>
                <li><a href="#section-3">3. é¡¹ç›®ç»“æ„</a></li>
                <li><a href="#section-4">4. æ•°æ®é›†è¯´æ˜</a></li>
                <li><a href="#section-5">5. Tokenizer å¤„ç†</a></li>
                <li><a href="#section-6">6. è®­ç»ƒæµç¨‹</a></li>
                <li><a href="#section-7">7. RL å¼ºåŒ–å­¦ä¹ è¯¦è§£</a></li>
                <li><a href="#section-8">8. å¿«é€Ÿå¼€å§‹</a></li>
                <li><a href="#section-9">9. é…ç½®è¯´æ˜</a></li>
                <li><a href="#section-10">10. ç›‘æ§ä¸å¯è§†åŒ–</a></li>
            </ol>
        </div>
    </nav>

    <main class="container">
        <!-- Section 1: é¡¹ç›®æ¦‚è¿° -->
        <section class="section" id="section-1">
            <h2>1. é¡¹ç›®æ¦‚è¿°</h2>
            <p>æœ¬é¡¹ç›®å®ç°äº† DeepSeek V3 çš„æ ¸å¿ƒæ¶æ„å’Œå®Œæ•´è®­ç»ƒæµç¨‹ï¼ŒåŒ…æ‹¬ï¼š</p>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>é˜¶æ®µ</th>
                            <th>æè¿°</th>
                            <th>æ•°æ®é›†</th>
                            <th>ç›®æ ‡</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Pretrain</strong></td>
                            <td>è¯­è¨€æ¨¡å‹é¢„è®­ç»ƒ</td>
                            <td>WikiText-2 / OpenWebText</td>
                            <td>å­¦ä¹ è¯­è¨€çŸ¥è¯†</td>
                        </tr>
                        <tr>
                            <td><strong>SFT</strong></td>
                            <td>æœ‰ç›‘ç£å¾®è°ƒ</td>
                            <td>Alpaca</td>
                            <td>å­¦ä¹ æŒ‡ä»¤è·Ÿéš</td>
                        </tr>
                        <tr>
                            <td><strong>RL</strong></td>
                            <td>å¼ºåŒ–å­¦ä¹ å¯¹é½</td>
                            <td>HH-RLHF</td>
                            <td>ä¸äººç±»åå¥½å¯¹é½</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h3>æ ¸å¿ƒåˆ›æ–°</h3>
            <div class="features-list">
                <div class="feature-item">
                    <strong>ğŸ§  MLA (Multi-head Latent Attention)</strong>
                    ä½ç§© KV å‹ç¼©ï¼Œå‡å°‘æ¨ç†æ—¶å†…å­˜å ç”¨
                </div>
                <div class="feature-item">
                    <strong>ğŸ”€ DeepSeekMoE</strong>
                    å…±äº«ä¸“å®¶ + è·¯ç”±ä¸“å®¶çš„æ··åˆä¸“å®¶æ¶æ„
                </div>
                <div class="feature-item">
                    <strong>ğŸ¯ MTP (Multi-Token Prediction)</strong>
                    å¤š token é¢„æµ‹ä½œä¸ºè¾…åŠ©è®­ç»ƒç›®æ ‡
                </div>
            </div>
        </section>

        <!-- Section 2: æ¶æ„è®¾è®¡ -->
        <section class="section" id="section-2">
            <h2>2. æ¶æ„è®¾è®¡</h2>

            <h3>2.1 Multi-head Latent Attention (MLA)</h3>
            <p>MLA æ˜¯ DeepSeek V3 çš„æ ¸å¿ƒæ³¨æ„åŠ›æœºåˆ¶ï¼Œé€šè¿‡ä½ç§©å‹ç¼© KV æ¥å‡å°‘å†…å­˜å ç”¨ã€‚</p>

            <h4>åŸç†</h4>
            <p>ä¼ ç»Ÿ Attention çš„ KV ç¼“å­˜å¤§å°ä¸º <code>O(H Ã— d_h)</code>ï¼ŒMLA å°†å…¶å‹ç¼©åˆ° <code>O(d_c)</code>ã€‚</p>

            <pre><code>Input: x âˆˆ R^(B Ã— L Ã— D)

<span class="comment"># KV å‹ç¼© (æ ¸å¿ƒåˆ›æ–°)</span>
c_kv = W_down(x)           <span class="comment"># (B, L, d_c)     - å‹ç¼©åˆ°ä½ç»´</span>
K = W_k_up(c_kv)           <span class="comment"># (B, L, H, d_h)  - æ‰©å±•ä¸º Key</span>
V = W_v_up(c_kv)           <span class="comment"># (B, L, H, d_h^v)- æ‰©å±•ä¸º Value</span>

<span class="comment"># Query ä½¿ç”¨ç‹¬ç«‹å‹ç¼©</span>
c_q = W_q_down(x)          <span class="comment"># (B, L, d_c')</span>
Q = W_q_up(c_q)            <span class="comment"># (B, L, H, d_h)</span>

<span class="comment"># Decoupled RoPE (è§£è€¦ä½ç½®ç¼–ç )</span>
Q_nope, Q_rope = split(Q)  <span class="comment"># åˆ†ç¦»ä½ç½®ç›¸å…³å’Œä½ç½®æ— å…³éƒ¨åˆ†</span>
K_nope, K_rope = split(K)

<span class="comment"># ä»…å¯¹ rope éƒ¨åˆ†åº”ç”¨æ—‹è½¬ä½ç½®ç¼–ç </span>
Q_rope, K_rope = apply_rope(Q_rope, K_rope)

<span class="comment"># é‡æ–°ç»„åˆ</span>
Q = concat(Q_nope, Q_rope)
K = concat(K_nope, K_rope)

<span class="comment"># æ ‡å‡† Attention</span>
Output = softmax(QK^T / âˆšd_h) Â· V</code></pre>

            <h4>å…³é”®å‚æ•°</h4>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>å‚æ•°</th>
                            <th>å«ä¹‰</th>
                            <th>é»˜è®¤å€¼</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>kv_lora_rank</code></td>
                            <td>KV å‹ç¼©ç»´åº¦ d_c</td>
                            <td>64</td>
                        </tr>
                        <tr>
                            <td><code>q_lora_rank</code></td>
                            <td>Q å‹ç¼©ç»´åº¦ d_c'</td>
                            <td>96</td>
                        </tr>
                        <tr>
                            <td><code>qk_nope_head_dim</code></td>
                            <td>é RoPE å¤´ç»´åº¦</td>
                            <td>32</td>
                        </tr>
                        <tr>
                            <td><code>qk_rope_head_dim</code></td>
                            <td>RoPE å¤´ç»´åº¦</td>
                            <td>32</td>
                        </tr>
                        <tr>
                            <td><code>v_head_dim</code></td>
                            <td>Value å¤´ç»´åº¦</td>
                            <td>64</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h4>ä»£ç ä½ç½®</h4>
            <p>å®ç°: <a href="attention.py">attention.py</a> - <code>MultiHeadLatentAttention</code> ç±»</p>

            <hr>

            <h3>2.2 DeepSeekMoEï¼ˆMixture of Expertsï¼‰</h3>
            <p>DeepSeekMoE ç»“åˆäº†å…±äº«ä¸“å®¶å’Œè·¯ç”±ä¸“å®¶ï¼Œæ—¢ä¿è¯é€šç”¨çŸ¥è¯†åˆæä¾›ä¸“ä¸šèƒ½åŠ›ã€‚</p>

            <h4>æ¶æ„</h4>
            <pre><code>Input: x âˆˆ R^(B Ã— L Ã— D)

<span class="comment"># 1. å…±äº«ä¸“å®¶ (Shared Experts) - å§‹ç»ˆæ¿€æ´»</span>
shared_out = Î£ expert_s(x) / n_shared

<span class="comment"># 2. è·¯ç”±ä¸“å®¶ (Routed Experts) - Top-K é€‰æ‹©</span>
router_probs = softmax(gate(x))           <span class="comment"># (B, L, N) è·¯ç”±æ¦‚ç‡</span>
top_k_probs, top_k_idx = topk(router_probs, K)  <span class="comment"># é€‰æ‹© Top-K ä¸“å®¶</span>
routed_out = Î£ (prob_i Ã— expert_i(x))     <span class="comment"># åŠ æƒè¾“å‡º</span>

<span class="comment"># 3. æœ€ç»ˆè¾“å‡º</span>
output = shared_out + routed_scaling_factor Ã— routed_out</code></pre>

            <h4>è´Ÿè½½å‡è¡¡æŸå¤±</h4>
            <p>ä¸ºäº†é˜²æ­¢ä¸“å®¶ä½¿ç”¨ä¸å‡è¡¡ï¼Œå¼•å…¥è¾…åŠ©æŸå¤±ï¼š</p>
            <div class="formula">
                L<sub>aux</sub> = Î± Ã— N Ã— Î£(f<sub>i</sub> Ã— P<sub>i</sub>)<br><br>
                å…¶ä¸­:<br>
                â€¢ f<sub>i</sub>: ä¸“å®¶ i æ¥æ”¶çš„ token æ¯”ä¾‹<br>
                â€¢ P<sub>i</sub>: ä¸“å®¶ i çš„å¹³å‡è·¯ç”±æ¦‚ç‡<br>
                â€¢ Î±: æŸå¤±ç³»æ•° (é»˜è®¤ 0.001)<br>
                â€¢ N: ä¸“å®¶æ€»æ•°
            </div>

            <h4>å…³é”®å‚æ•°</h4>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>å‚æ•°</th>
                            <th>å«ä¹‰</th>
                            <th>é»˜è®¤å€¼</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>num_experts</code></td>
                            <td>è·¯ç”±ä¸“å®¶æ€»æ•° N</td>
                            <td>16</td>
                        </tr>
                        <tr>
                            <td><code>num_experts_per_tok</code></td>
                            <td>æ¯ token æ¿€æ´»ä¸“å®¶æ•° K</td>
                            <td>2</td>
                        </tr>
                        <tr>
                            <td><code>num_shared_experts</code></td>
                            <td>å…±äº«ä¸“å®¶æ•°</td>
                            <td>2</td>
                        </tr>
                        <tr>
                            <td><code>expert_hidden_size</code></td>
                            <td>ä¸“å®¶ FFN éšè—ç»´åº¦</td>
                            <td>768</td>
                        </tr>
                        <tr>
                            <td><code>aux_loss_alpha</code></td>
                            <td>è¾…åŠ©æŸå¤±ç³»æ•°</td>
                            <td>0.001</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h4>ä»£ç ä½ç½®</h4>
            <p>å®ç°: <a href="model.py">model.py</a> - <code>DeepSeekMoE</code>, <code>MoEGate</code>, <code>Expert</code> ç±»</p>

            <hr>

            <h3>2.3 Multi-Token Prediction (MTP)</h3>
            <p>MTP åŒæ—¶é¢„æµ‹å¤šä¸ªæœªæ¥ tokenï¼Œä½œä¸ºè¾…åŠ©è®­ç»ƒç›®æ ‡ï¼ŒåŒæ—¶æ”¯æŒæ¨ç†æ—¶çš„æŠ•æœºè§£ç ã€‚</p>

            <h4>åŸç†</h4>
            <pre><code>Input: hidden_states âˆˆ R^(B Ã— L Ã— D)

<span class="comment"># å¯¹æ¯ä¸ªé¢„æµ‹æ·±åº¦ d âˆˆ [1, D_predict]</span>
<span class="keyword">for</span> d <span class="keyword">in</span> range(<span class="number">1</span>, num_predict_tokens + <span class="number">1</span>):
    <span class="comment"># ç‹¬ç«‹çš„æŠ•å½±å±‚</span>
    h_d = projection_d(hidden_states)
    h_d = layer_norm_d(h_d)
    logits_d = output_head_d(h_d)  <span class="comment"># é¢„æµ‹ä½ç½® i+d å¤„çš„ token</span>

<span class="comment"># è®­ç»ƒæ—¶è®¡ç®— MTP Loss</span>
mtp_loss = Î£ CE(logits_d[:, :-d-<span class="number">1</span>], labels[:, d+<span class="number">1</span>:])
total_loss = lm_loss + mtp_weight Ã— mtp_loss</code></pre>

            <h4>å…³é”®å‚æ•°</h4>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>å‚æ•°</th>
                            <th>å«ä¹‰</th>
                            <th>é»˜è®¤å€¼</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>num_predict_tokens</code></td>
                            <td>é¢å¤–é¢„æµ‹çš„ token æ•°</td>
                            <td>2</td>
                        </tr>
                        <tr>
                            <td><code>mtp_loss_weight</code></td>
                            <td>MTP æŸå¤±æƒé‡</td>
                            <td>0.3</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h4>ä»£ç ä½ç½®</h4>
            <p>å®ç°: <a href="model.py">model.py</a> - <code>MTPHead</code> ç±»</p>
        </section>

        <!-- Section 3: é¡¹ç›®ç»“æ„ -->
        <section class="section" id="section-3">
            <h2>3. é¡¹ç›®ç»“æ„</h2>

            <div class="file-tree">
<span class="folder">deepseek_v3/</span>
â”œâ”€â”€ <span class="file">config.py</span>               <span class="comment"># é…ç½®ç®¡ç† (æ‰€æœ‰é…ç½®ç±»å®šä¹‰)</span>
â”œâ”€â”€ <span class="file">config_default.yaml</span>     <span class="comment"># é»˜è®¤é…ç½® (å°æ•°æ®é›†)</span>
â”œâ”€â”€ <span class="file">config_large.yaml</span>       <span class="comment"># å¤§è§„æ¨¡è®­ç»ƒé…ç½®</span>
â”œâ”€â”€ <span class="file">attention.py</span>            <span class="comment"># MLA æ³¨æ„åŠ›å®ç°</span>
â”œâ”€â”€ <span class="file">model.py</span>                <span class="comment"># DeepSeek V3 æ¨¡å‹ä¸»ä½“</span>
â”œâ”€â”€ <span class="file">dataset.py</span>              <span class="comment"># æ•°æ®é›†å¤„ç† (Pretrain/SFT/RL)</span>
â”œâ”€â”€ <span class="file">rl_dataset.py</span>           <span class="comment"># RL ä¸“ç”¨æ•°æ®é›†</span>
â”œâ”€â”€ <span class="file">trainer.py</span>              <span class="comment"># è®­ç»ƒå™¨ (Pretrain/SFT/GRPO)</span>
â”œâ”€â”€ <span class="file">rl_trainer_base.py</span>      <span class="comment"># RL è®­ç»ƒåŸºç±»</span>
â”œâ”€â”€ <span class="file">rl_trainer_algorithms.py</span> <span class="comment"># RL ç®—æ³•å®ç° (GRPO/PPO)</span>
â”œâ”€â”€ <span class="file">train.py</span>                <span class="comment"># è®­ç»ƒå…¥å£è„šæœ¬</span>
â”œâ”€â”€ <span class="file">rl_train.py</span>             <span class="comment"># RL è®­ç»ƒå…¥å£</span>
â”œâ”€â”€ <span class="file">inference.py</span>            <span class="comment"># æ¨ç†å’Œç”Ÿæˆ</span>
â”œâ”€â”€ <span class="file">logger.py</span>               <span class="comment"># æ—¥å¿—æ¨¡å— (å½©è‰²è¾“å‡ºã€å¤šçº§åˆ«æ—¥å¿—)</span>
â”œâ”€â”€ <span class="file">run.sh</span>                  <span class="comment"># ä¾¿æ·è¿è¡Œè„šæœ¬</span>
â”œâ”€â”€ <span class="file">run_pretrain.sh</span>         <span class="comment"># é¢„è®­ç»ƒä¸“ç”¨è„šæœ¬</span>
â”œâ”€â”€ <span class="file">test_all.py</span>             <span class="comment"># æµ‹è¯•å¥—ä»¶</span>
â”œâ”€â”€ <span class="file">test_rl.py</span>              <span class="comment"># RL æµ‹è¯•</span>
â”œâ”€â”€ <span class="file">requirements.txt</span>        <span class="comment"># Python ä¾èµ–</span>
â””â”€â”€ <span class="file">README.md</span>               <span class="comment"># é¡¹ç›®è¯´æ˜</span>
            </div>

            <h3>3.1 æ—¥å¿—æ¨¡å— (logger.py)</h3>
            <p>é¡¹ç›®æä¾›ç»Ÿä¸€çš„æ—¥å¿—ç®¡ç†åŠŸèƒ½ï¼Œæ”¯æŒå½©è‰²è¾“å‡ºå’Œä¸åŒæ—¥å¿—çº§åˆ«ã€‚</p>

            <h4>æ—¥å¿—çº§åˆ«é¢œè‰²</h4>
            <div class="log-levels">
                <div class="log-level debug">ğŸ” DEBUG<br><small>é’è‰² (Cyan)</small></div>
                <div class="log-level info">â„¹ï¸ INFO<br><small>ç»¿è‰² (Green)</small></div>
                <div class="log-level warning">âš ï¸ WARNING<br><small>é»„è‰² (Yellow)</small></div>
                <div class="log-level error">âŒ ERROR<br><small>çº¢è‰² (Red)</small></div>
                <div class="log-level critical">ğŸ”¥ CRITICAL<br><small>ç²—ä½“çº¢è‰²</small></div>
            </div>

            <h4>æ—¥å¿—æ ¼å¼</h4>
            <pre><code>[æ—¶é—´] [PID:TID] [ç¬¦å·] [çº§åˆ«] [æ–‡ä»¶:è¡Œå·] æ¶ˆæ¯</code></pre>

            <p>ç¤ºä¾‹:</p>
            <pre><code>2025-12-27 10:30:00 [12345:67890] â„¹ï¸  [  INFO  ] [train.py:100] Training started</code></pre>

            <h4>ä½¿ç”¨æ–¹æ³•</h4>
            <pre><code><span class="keyword">from</span> logger <span class="keyword">import</span> get_logger, set_log_level
<span class="keyword">import</span> logging

<span class="comment"># è·å– logger</span>
logger = get_logger(__name__)

<span class="comment"># ä½¿ç”¨ä¸åŒçº§åˆ«çš„æ—¥å¿—</span>
logger.debug(<span class="string">"Detailed debugging info"</span>)
logger.info(<span class="string">"General information"</span>)
logger.warning(<span class="string">"Potential issue"</span>)
logger.error(<span class="string">"Error occurred"</span>)

<span class="comment"># è®¾ç½®å…¨å±€æ—¥å¿—çº§åˆ«</span>
set_log_level(logging.DEBUG)

<span class="comment"># æ·»åŠ æ–‡ä»¶æ—¥å¿—</span>
<span class="keyword">from</span> logger <span class="keyword">import</span> setup_file_logging
setup_file_logging(<span class="string">"logs/training.log"</span>)</code></pre>
        </section>

        <!-- Section 4: æ•°æ®é›†è¯´æ˜ -->
        <section class="section" id="section-4">
            <h2>4. æ•°æ®é›†è¯´æ˜</h2>

            <h3>4.1 Pretrain æ•°æ®é›†</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>æ•°æ®é›†</th>
                            <th>è§„æ¨¡</th>
                            <th>å‚æ•°</th>
                            <th>ç”¨é€”</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>WikiText-2</strong></td>
                            <td>~13MB</td>
                            <td><code>--dataset_scale small</code></td>
                            <td>å¿«é€Ÿæµ‹è¯•/å®éªŒ</td>
                        </tr>
                        <tr>
                            <td><strong>OpenWebText</strong></td>
                            <td>~40GB</td>
                            <td><code>--dataset_scale large</code></td>
                            <td>æ­£å¼è®­ç»ƒ</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h4>WikiText-2 æ ¼å¼</h4>
            <p>åŸå§‹æ–‡æœ¬ï¼Œæ¯è¡Œæ˜¯ä¸€æ®µæ–‡ç« ï¼š</p>
            <pre><code>= Valkyria Chronicles III =
SenjÅ no Valkyria 3 : Unrecorded Chronicles ( Japanese : æˆ¦å ´ã®...</code></pre>

            <h4>OpenWebText æ ¼å¼</h4>
            <p>Reddit å¤–é“¾æ–‡ç« çš„æ–‡æœ¬å†…å®¹ï¼š</p>
            <pre><code>{
    <span class="string">"text"</span>: <span class="string">"The full article content..."</span>
}</code></pre>

            <h3>4.2 SFT æ•°æ®é›†</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>æ•°æ®é›†</th>
                            <th>è§„æ¨¡</th>
                            <th>æ ¼å¼</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Alpaca</strong></td>
                            <td>~52K æ ·æœ¬</td>
                            <td>instruction-input-output</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h4>Alpaca æ ¼å¼</h4>
            <pre><code>{
    <span class="string">"instruction"</span>: <span class="string">"Give three tips for staying healthy."</span>,
    <span class="string">"input"</span>: <span class="string">""</span>,
    <span class="string">"output"</span>: <span class="string">"1. Eat a balanced diet...\n2. Exercise regularly...\n3. Get enough sleep..."</span>
}</code></pre>

            <h4>æ ¼å¼åŒ–æ¨¡æ¿</h4>
            <pre><code>### Instruction:
{instruction}

### Input:
{input}

### Response:
{output}</code></pre>

            <h3>4.3 RL æ•°æ®é›†</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>æ•°æ®é›†</th>
                            <th>è§„æ¨¡</th>
                            <th>æ ¼å¼</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>HH-RLHF</strong></td>
                            <td>~170K</td>
                            <td>chosen/rejected pairs</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h4>HH-RLHF æ ¼å¼</h4>
            <pre><code>{
    <span class="string">"chosen"</span>: <span class="string">"Human: What is...\n\nAssistant: The answer is..."</span>,
    <span class="string">"rejected"</span>: <span class="string">"Human: What is...\n\nAssistant: I don't know..."</span>
}</code></pre>
        </section>

        <!-- Section 5: Tokenizer å¤„ç† -->
        <section class="section" id="section-5">
            <h2>5. Tokenizer å¤„ç†</h2>
            <p>æœ¬é¡¹ç›®ä½¿ç”¨ GPT-2 Tokenizerï¼ˆå¯é…ç½®å…¶ä»– HuggingFace tokenizerï¼‰ã€‚</p>

            <h3>5.1 åŠ è½½ Tokenizer</h3>
            <pre><code><span class="keyword">from</span> transformers <span class="keyword">import</span> AutoTokenizer

tokenizer = AutoTokenizer.from_pretrained(<span class="string">"gpt2"</span>)

<span class="comment"># è®¾ç½® padding token (GPT-2 é»˜è®¤æ²¡æœ‰)</span>
<span class="keyword">if</span> tokenizer.pad_token <span class="keyword">is</span> <span class="keyword">None</span>:
    tokenizer.pad_token = tokenizer.eos_token
    tokenizer.pad_token_id = tokenizer.eos_token_id</code></pre>

            <h3>5.2 Pretrain æ•°æ®å¤„ç†</h3>
            <pre><code><span class="comment"># 1. å°†æ‰€æœ‰æ–‡æœ¬æ‹¼æ¥</span>
all_text = <span class="string">" "</span>.join(texts)

<span class="comment"># 2. Tokenize</span>
tokens = tokenizer.encode(all_text, add_special_tokens=<span class="keyword">False</span>)

<span class="comment"># 3. åˆ‡åˆ†æˆå›ºå®šé•¿åº¦çš„åºåˆ—</span>
<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, len(tokens) - max_seq_length, max_seq_length):
    chunk = tokens[i:i + max_seq_length]
    examples.append({
        <span class="string">'input_ids'</span>: torch.tensor(chunk),
        <span class="string">'attention_mask'</span>: torch.ones(len(chunk)),
        <span class="string">'labels'</span>: torch.tensor(chunk),  <span class="comment"># è‡ªå›å½’ï¼Œlabels = input_ids</span>
    })</code></pre>

            <h3>5.3 SFT æ•°æ®å¤„ç†</h3>
            <pre><code><span class="comment"># 1. æ ¼å¼åŒ– prompt å’Œå®Œæ•´æ–‡æœ¬</span>
prompt = <span class="string">f"### Instruction:\n{instruction}\n\n### Response:\n"</span>
full_text = prompt + output

<span class="comment"># 2. Tokenize</span>
prompt_ids = tokenizer.encode(prompt)
full_ids = tokenizer.encode(full_text)

<span class="comment"># 3. åˆ›å»º labels (prompt éƒ¨åˆ†ä¸º -100ï¼Œä¸è®¡ç®— loss)</span>
labels = [<span class="number">-100</span>] * len(prompt_ids) + full_ids[len(prompt_ids):]</code></pre>

            <h3>5.4 å…³é”®é…ç½®</h3>
            <pre><code><span class="keyword">data:</span>
  tokenizer_name: <span class="string">"gpt2"</span>           <span class="comment"># å¯æ”¹ä¸ºå…¶ä»– tokenizer</span>
  pretrain_max_seq_length: <span class="number">512</span>     <span class="comment"># é¢„è®­ç»ƒåºåˆ—é•¿åº¦</span>
  sft_max_seq_length: <span class="number">512</span>          <span class="comment"># SFT åºåˆ—é•¿åº¦</span>
  rl_max_seq_length: <span class="number">256</span>           <span class="comment"># RL åºåˆ—é•¿åº¦</span></code></pre>
        </section>

        <!-- Section 6: è®­ç»ƒæµç¨‹ -->
        <section class="section" id="section-6">
            <h2>6. è®­ç»ƒæµç¨‹</h2>

            <h3>6.1 Pretrain é¢„è®­ç»ƒ</h3>
            <h4>ç›®æ ‡</h4>
            <p>å­¦ä¹ è¯­è¨€æ¨¡å‹çš„åŸºç¡€èƒ½åŠ›ï¼šè¯­æ³•ã€çŸ¥è¯†ã€æ¨ç†ã€‚</p>

            <h4>Loss å‡½æ•°</h4>
            <pre><code><span class="comment"># Next-Token Prediction Loss</span>
loss = CrossEntropyLoss(logits[:, :-<span class="number">1</span>], labels[:, <span class="number">1</span>:])

<span class="comment"># + MTP Loss (if enabled)</span>
<span class="keyword">for</span> d <span class="keyword">in</span> range(<span class="number">1</span>, num_predict_tokens + <span class="number">1</span>):
    mtp_loss += CrossEntropyLoss(mtp_logits_d[:, :-d-<span class="number">1</span>], labels[:, d+<span class="number">1</span>:])
loss += mtp_weight * mtp_loss / num_predict_tokens

<span class="comment"># + MoE Auxiliary Loss (if enabled)</span>
loss += aux_loss</code></pre>

            <h4>è¿è¡Œå‘½ä»¤</h4>
            <pre><code><span class="comment"># å°æ•°æ®é›†å¿«é€Ÿæµ‹è¯• (WikiText-2, ~13MB)</span>
python train.py --mode pretrain --dataset_scale small --test

<span class="comment"># å°æ•°æ®é›†å®Œæ•´è®­ç»ƒ</span>
python train.py --mode pretrain --dataset_scale small

<span class="comment"># å¤§æ•°æ®é›†è®­ç»ƒ (OpenWebText, ~10GB)</span>
python train.py --mode pretrain --dataset_scale large

<span class="comment"># ä½¿ç”¨ run.sh è„šæœ¬</span>
./run.sh pretrain          <span class="comment"># å°æ•°æ®é›†</span>
./run.sh pretrain-large    <span class="comment"># å¤§æ•°æ®é›†</span>
./run.sh pretrain-test     <span class="comment"># å¿«é€Ÿæµ‹è¯•</span></code></pre>

            <h4>å…³é”®å‚æ•°</h4>
            <pre><code><span class="keyword">pretraining:</span>
  batch_size: <span class="number">16</span>
  learning_rate: <span class="number">3e-4</span>
  max_steps: <span class="number">5000</span>
  warmup_steps: <span class="number">200</span>
  gradient_accumulation_steps: <span class="number">2</span>
  max_grad_norm: <span class="number">1.0</span></code></pre>

            <hr>

            <h3>6.2 SFT æœ‰ç›‘ç£å¾®è°ƒ</h3>
            <h4>ç›®æ ‡</h4>
            <p>å­¦ä¹ éµå¾ªæŒ‡ä»¤ã€ç”Ÿæˆæœ‰å¸®åŠ©çš„å›å¤ã€‚</p>

            <h4>Loss å‡½æ•°</h4>
            <pre><code><span class="comment"># åªåœ¨ response éƒ¨åˆ†è®¡ç®— loss</span>
<span class="comment"># labels ä¸­ prompt éƒ¨åˆ†è®¾ä¸º -100</span>
loss = CrossEntropyLoss(logits, labels, ignore_index=<span class="number">-100</span>)</code></pre>

            <h4>è¿è¡Œå‘½ä»¤</h4>
            <pre><code><span class="comment"># ä»é¢„è®­ç»ƒæ£€æŸ¥ç‚¹å¼€å§‹ SFT</span>
python train.py --mode sft --checkpoint checkpoints/pretrain/best.pt

<span class="comment"># ä½¿ç”¨ run.sh</span>
./run.sh sft checkpoints/pretrain/best.pt
./run.sh sft-test  <span class="comment"># å¿«é€Ÿæµ‹è¯•</span></code></pre>

            <h4>å…³é”®å‚æ•°</h4>
            <pre><code><span class="keyword">sft:</span>
  batch_size: <span class="number">8</span>
  learning_rate: <span class="number">2e-5</span>      <span class="comment"># æ¯”é¢„è®­ç»ƒå°</span>
  max_steps: <span class="number">2000</span>
  warmup_ratio: <span class="number">0.03</span>
  weight_decay: <span class="number">0.0</span>        <span class="comment"># SFT é€šå¸¸ä¸ç”¨ weight decay</span></code></pre>

            <hr>

            <h3>6.3 RL å¼ºåŒ–å­¦ä¹ </h3>
            <h4>ç›®æ ‡</h4>
            <p>å°†æ¨¡å‹ä¸äººç±»åå¥½å¯¹é½ï¼Œç”Ÿæˆæ›´æœ‰å¸®åŠ©ã€æ›´å®‰å…¨çš„å›å¤ã€‚</p>

            <h4>æ”¯æŒçš„ç®—æ³•</h4>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ç®—æ³•</th>
                            <th>ç±»å‹</th>
                            <th>ç‰¹ç‚¹</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>GRPO</strong></td>
                            <td><span class="badge online">Online</span></td>
                            <td>DeepSeek é£æ ¼ï¼Œç»„å†…ç›¸å¯¹ä¼˜åŠ¿</td>
                        </tr>
                        <tr>
                            <td><strong>PPO</strong></td>
                            <td><span class="badge online">Online</span></td>
                            <td>ç»å…¸ RLHFï¼Œéœ€è¦ value function</td>
                        </tr>
                        <tr>
                            <td><strong>DPO</strong></td>
                            <td><span class="badge offline">Offline</span></td>
                            <td>ç›´æ¥ä¼˜åŒ–åå¥½ï¼Œæ— éœ€ reward model</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h4>è¿è¡Œå‘½ä»¤</h4>
            <pre><code><span class="comment"># GRPO (é»˜è®¤)</span>
python train.py --mode rl --checkpoint checkpoints/sft/best.pt

<span class="comment"># æŒ‡å®šç®—æ³•</span>
python rl_train.py --algorithm grpo --checkpoint checkpoints/sft/best.pt
python rl_train.py --algorithm ppo --checkpoint checkpoints/sft/best.pt
python rl_train.py --algorithm dpo --checkpoint checkpoints/sft/best.pt

<span class="comment"># ä½¿ç”¨ run.sh</span>
./run.sh rl checkpoints/sft/best.pt
./run.sh rl-test</code></pre>
        </section>

        <!-- Section 7: RL å¼ºåŒ–å­¦ä¹ è¯¦è§£ -->
        <section class="section" id="section-7">
            <h2>7. RL å¼ºåŒ–å­¦ä¹ è¯¦è§£</h2>

            <h3>7.1 GRPO (Group Relative Policy Optimization)</h3>
            <p>GRPO æ˜¯ DeepSeek æå‡ºçš„ RL ç®—æ³•ï¼Œæ— éœ€å­¦ä¹  reward modelï¼Œä½¿ç”¨ç»„å†…ç›¸å¯¹ä¼˜åŠ¿ã€‚</p>

            <h4>ç®—æ³•æµç¨‹</h4>
            <pre><code>For each prompt x:
    <span class="number">1.</span> ç”Ÿæˆ G ä¸ªå“åº” {y_1, y_2, ..., y_G}
    <span class="number">2.</span> è®¡ç®—æ¯ä¸ªå“åº”çš„ reward r_i = R(x, y_i)
    <span class="number">3.</span> è®¡ç®—ç»„å†…ç›¸å¯¹ä¼˜åŠ¿:
       A_i = (r_i - mean(r)) / (std(r) + Îµ)
    <span class="number">4.</span> è®¡ç®— policy gradient loss:
       L_PG = -E[A_i Ã— log Ï€(y_i|x)]
    <span class="number">5.</span> è®¡ç®— KL æƒ©ç½š:
       L_KL = Î² Ã— KL(Ï€ || Ï€_ref)
    <span class="number">6.</span> æ€»æŸå¤±:
       L = L_PG + L_KL</code></pre>

            <h4>æ ¸å¿ƒä»£ç </h4>
            <pre><code><span class="comment"># ç»„å†…ç›¸å¯¹ä¼˜åŠ¿å½’ä¸€åŒ–</span>
rewards_t = torch.tensor(rewards)
mean_r = rewards_t.mean()
std_r = rewards_t.std() + <span class="number">1e-8</span>
advantages = (rewards_t - mean_r) / std_r

<span class="comment"># Policy Gradient Loss</span>
<span class="keyword">for</span> adv, log_prob <span class="keyword">in</span> zip(advantages, log_probs):
    pg_loss += -adv * log_prob.mean()

<span class="comment"># KL Penalty</span>
kl = (policy_logps - ref_logps).mean()
loss = pg_loss + kl_coef * kl</code></pre>

            <h4>å…³é”®å‚æ•°</h4>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>å‚æ•°</th>
                            <th>å«ä¹‰</th>
                            <th>é»˜è®¤å€¼</th>
                            <th>è¯´æ˜</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>group_size</code></td>
                            <td>æ¯ä¸ª prompt ç”Ÿæˆçš„å“åº”æ•°</td>
                            <td>4</td>
                            <td>è¶Šå¤§æ–¹å·®ä¼°è®¡è¶Šå‡†ï¼Œä½†è®¡ç®—é‡å¤§</td>
                        </tr>
                        <tr>
                            <td><code>kl_coef</code></td>
                            <td>KL æƒ©ç½šç³»æ•° Î²</td>
                            <td>0.1</td>
                            <td>é˜²æ­¢åç¦»å‚è€ƒæ¨¡å‹å¤ªè¿œ</td>
                        </tr>
                        <tr>
                            <td><code>temperature</code></td>
                            <td>é‡‡æ ·æ¸©åº¦</td>
                            <td>0.7</td>
                            <td>æ§åˆ¶ç”Ÿæˆå¤šæ ·æ€§</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <hr>

            <h3>7.2 PPO (Proximal Policy Optimization)</h3>
            <p>PPO æ˜¯ç»å…¸çš„ RLHF ç®—æ³•ï¼Œä½¿ç”¨ value function ä¼°è®¡ä¼˜åŠ¿ã€‚</p>

            <h4>ç®—æ³•æµç¨‹</h4>
            <pre><code><span class="number">1.</span> Rollout: ç”Ÿæˆå“åº”ï¼Œè®¡ç®— reward
<span class="number">2.</span> è®¡ç®— GAE (Generalized Advantage Estimation):
   Î´_t = r_t + Î³ V(s_{t+1}) - V(s_t)
   A_t = Î£ (Î³Î»)^k Î´_{t+k}
<span class="number">3.</span> PPO Update (å¤šä¸ª epoch):
   a. è®¡ç®— probability ratio: Ï = Ï€(a|s) / Ï€_old(a|s)
   b. Clipped surrogate objective:
      L_clip = min(Ï A, clip(Ï, 1-Îµ, 1+Îµ) A)
   c. Value function loss:
      L_VF = MSE(V(s), R_t)
   d. Entropy bonus:
      H = -Î£ Ï€ log Ï€
   e. Total loss:
      L = -L_clip + c1 Ã— L_VF - c2 Ã— H</code></pre>

            <h4>å…³é”®å‚æ•°</h4>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>å‚æ•°</th>
                            <th>å«ä¹‰</th>
                            <th>é»˜è®¤å€¼</th>
                            <th>è¯´æ˜</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>clip_range</code></td>
                            <td>PPO è£å‰ªèŒƒå›´ Îµ</td>
                            <td>0.2</td>
                            <td>é™åˆ¶ç­–ç•¥æ›´æ–°å¹…åº¦</td>
                        </tr>
                        <tr>
                            <td><code>value_coef</code></td>
                            <td>Value loss ç³»æ•° c1</td>
                            <td>0.5</td>
                            <td></td>
                        </tr>
                        <tr>
                            <td><code>entropy_coef</code></td>
                            <td>Entropy bonus ç³»æ•° c2</td>
                            <td>0.01</td>
                            <td>é¼“åŠ±æ¢ç´¢</td>
                        </tr>
                        <tr>
                            <td><code>gae_lambda</code></td>
                            <td>GAE Î» å‚æ•°</td>
                            <td>0.95</td>
                            <td>æ–¹å·®-åå·®æƒè¡¡</td>
                        </tr>
                        <tr>
                            <td><code>ppo_epochs</code></td>
                            <td>æ¯æ‰¹æ•°æ®çš„ PPO æ›´æ–°æ¬¡æ•°</td>
                            <td>4</td>
                            <td></td>
                        </tr>
                        <tr>
                            <td><code>target_kl</code></td>
                            <td>KL æ—©åœé˜ˆå€¼</td>
                            <td>0.02</td>
                            <td>è¶…è¿‡åˆ™åœæ­¢æ›´æ–°</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <hr>

            <h3>7.3 DPO (Direct Preference Optimization)</h3>
            <p>DPO ç›´æ¥ä»åå¥½æ•°æ®å­¦ä¹ ï¼Œæ— éœ€æ˜¾å¼ reward modelã€‚</p>

            <h4>ç®—æ³•åŸç†</h4>
            <div class="formula">
                ç»™å®šåå¥½æ•°æ® (x, y<sub>w</sub>, y<sub>l</sub>)ï¼Œå…¶ä¸­ y<sub>w</sub> æ˜¯äººç±»åå¥½çš„å“åº”ï¼Œy<sub>l</sub> æ˜¯ä¸åå¥½çš„å“åº”<br><br>
                <strong>DPO Loss:</strong><br>
                L<sub>DPO</sub> = -E[log Ïƒ(Î² Ã— (log Ï€(y<sub>w</sub>|x)/Ï€<sub>ref</sub>(y<sub>w</sub>|x) - log Ï€(y<sub>l</sub>|x)/Ï€<sub>ref</sub>(y<sub>l</sub>|x)))]<br><br>
                ç®€åŒ–ä¸º: L<sub>DPO</sub> = -E[log Ïƒ(Î² Ã— (r<sub>w</sub> - r<sub>l</sub>))]<br><br>
                å…¶ä¸­: r = log Ï€(y|x) - log Ï€<sub>ref</sub>(y|x) &nbsp; <em>(éšå¼ reward)</em>
            </div>

            <h4>æ ¸å¿ƒä»£ç </h4>
            <pre><code><span class="comment"># è®¡ç®— policy å’Œ reference çš„ log probabilities</span>
policy_logps_w = compute_log_probs(model, y_w)
policy_logps_l = compute_log_probs(model, y_l)
ref_logps_w = compute_log_probs(ref_model, y_w)
ref_logps_l = compute_log_probs(ref_model, y_l)

<span class="comment"># è®¡ç®— reward margin</span>
logits_w = policy_logps_w - ref_logps_w
logits_l = policy_logps_l - ref_logps_l
logits_diff = logits_w - logits_l

<span class="comment"># DPO Loss</span>
loss = -F.logsigmoid(beta * logits_diff).mean()</code></pre>

            <h4>å…³é”®å‚æ•°</h4>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>å‚æ•°</th>
                            <th>å«ä¹‰</th>
                            <th>é»˜è®¤å€¼</th>
                            <th>è¯´æ˜</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>dpo_beta</code></td>
                            <td>æ¸©åº¦å‚æ•° Î²</td>
                            <td>0.1</td>
                            <td>è¶Šå¤§ç­–ç•¥å˜åŒ–è¶Šæ¿€è¿›</td>
                        </tr>
                        <tr>
                            <td><code>dpo_label_smoothing</code></td>
                            <td>æ ‡ç­¾å¹³æ»‘</td>
                            <td>0.0</td>
                            <td>å¢åŠ é²æ£’æ€§</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <hr>

            <h3>7.4 Loss å‡½æ•°ä¸æ³¨æ„äº‹é¡¹</h3>

            <h4>RL è®­ç»ƒçš„ä¸»è¦ Loss ç»„ä»¶</h4>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Loss</th>
                            <th>å…¬å¼</th>
                            <th>ä½œç”¨</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Policy Gradient</strong></td>
                            <td><code>-A Ã— log Ï€(y|x)</code></td>
                            <td>æé«˜é«˜ reward å“åº”çš„æ¦‚ç‡</td>
                        </tr>
                        <tr>
                            <td><strong>KL Penalty</strong></td>
                            <td><code>Î² Ã— KL(Ï€ || Ï€_ref)</code></td>
                            <td>é˜²æ­¢åç¦»å‚è€ƒæ¨¡å‹å¤ªè¿œ</td>
                        </tr>
                        <tr>
                            <td><strong>Value Loss</strong></td>
                            <td><code>MSE(V, R)</code></td>
                            <td>å‡†ç¡®ä¼°è®¡çŠ¶æ€ä»·å€¼</td>
                        </tr>
                        <tr>
                            <td><strong>Entropy Bonus</strong></td>
                            <td><code>-H(Ï€)</code></td>
                            <td>é¼“åŠ±æ¢ç´¢</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h4>è®­ç»ƒæ³¨æ„äº‹é¡¹</h4>
            <ol>
                <li><strong>å­¦ä¹ ç‡</strong>ï¼šRL é˜¶æ®µä½¿ç”¨éå¸¸å°çš„å­¦ä¹ ç‡ï¼ˆ~5e-7ï¼‰ï¼Œé˜²æ­¢æ¨¡å‹èƒ½åŠ›é€€åŒ–</li>
                <li><strong>KL æ§åˆ¶</strong>ï¼š
                    <ul>
                        <li>ç›‘æ§ KL æ•£åº¦ï¼Œè¿‡å¤§è¯´æ˜ç­–ç•¥å˜åŒ–å¤ªå¿«</li>
                        <li>ä½¿ç”¨ target_kl æ—©åœæœºåˆ¶</li>
                        <li>é€‚å½“è°ƒæ•´ kl_coef</li>
                    </ul>
                </li>
                <li><strong>Reward è®¾è®¡</strong>ï¼š
                    <ul>
                        <li>æœ¬é¡¹ç›®ä½¿ç”¨è§„åˆ™ rewardï¼ˆé•¿åº¦ã€è¿è´¯æ€§ã€é‡å¤æƒ©ç½šç­‰ï¼‰</li>
                        <li>ç”Ÿäº§ç¯å¢ƒåº”ä½¿ç”¨ learned reward model</li>
                    </ul>
                </li>
                <li><strong>Reward Hacking</strong>ï¼š
                    <ul>
                        <li>æ¨¡å‹å¯èƒ½æ‰¾åˆ° reward çš„æ¼æ´</li>
                        <li>ä½¿ç”¨å¤šæ ·åŒ–çš„ reward ä¿¡å·</li>
                        <li>ä¿æŒ KL çº¦æŸ</li>
                    </ul>
                </li>
                <li><strong>è®­ç»ƒç¨³å®šæ€§</strong>ï¼š
                    <ul>
                        <li>ä½¿ç”¨æ¢¯åº¦è£å‰ª <code>max_grad_norm: 1.0</code></li>
                        <li>ä½¿ç”¨æ¢¯åº¦ç´¯ç§¯å¹³æ»‘æ›´æ–°</li>
                        <li>ç›‘æ§ reward å’Œ loss æ›²çº¿</li>
                    </ul>
                </li>
                <li><strong>Reference Model</strong>ï¼š
                    <ul>
                        <li>ä¿æŒå†»ç»“ï¼Œä¸æ›´æ–°å‚æ•°</li>
                        <li>ç”¨äºè®¡ç®— KL æ•£åº¦</li>
                        <li>é˜²æ­¢æ¨¡å‹é€€åŒ–</li>
                    </ul>
                </li>
            </ol>
        </section>

        <!-- Section 8: å¿«é€Ÿå¼€å§‹ -->
        <section class="section" id="section-8">
            <h2>8. å¿«é€Ÿå¼€å§‹</h2>

            <h3>8.1 å®‰è£…ä¾èµ–</h3>
            <pre><code>cd learn/deepseek_v3
pip install -r requirements.txt
chmod +x run.sh</code></pre>

            <h3>8.2 è¿è¡Œæµ‹è¯•</h3>
            <pre><code><span class="comment"># æµ‹è¯•æ¨¡å‹å’Œè®­ç»ƒæµç¨‹</span>
./run.sh test-quick

<span class="comment"># å®Œæ•´æµ‹è¯•</span>
./run.sh test</code></pre>

            <h3>8.3 å®Œæ•´è®­ç»ƒæµç¨‹</h3>
            <pre><code><span class="comment"># 1. Pretrain (å°æ•°æ®é›†å¿«é€ŸéªŒè¯)</span>
./run.sh pretrain-test

<span class="comment"># æˆ–å®Œæ•´é¢„è®­ç»ƒ</span>
./run.sh pretrain

<span class="comment"># 2. SFT</span>
./run.sh sft checkpoints/pretrain/best.pt

<span class="comment"># 3. RL (GRPO)</span>
./run.sh rl checkpoints/sft/best.pt

<span class="comment"># 4. æ¨ç†</span>
./run.sh inference checkpoints/rl/best.pt

<span class="comment"># 5. äº¤äº’å¼å¯¹è¯</span>
./run.sh chat checkpoints/rl/best.pt</code></pre>

            <h3>8.4 ä¸€é”®å®Œæ•´æµç¨‹</h3>
            <pre><code><span class="comment"># å¿«é€Ÿæµ‹è¯•æ•´ä¸ªæµç¨‹</span>
./run.sh full-test

<span class="comment"># å®Œæ•´è®­ç»ƒæµç¨‹</span>
./run.sh full</code></pre>
        </section>

        <!-- Section 9: é…ç½®è¯´æ˜ -->
        <section class="section" id="section-9">
            <h2>9. é…ç½®è¯´æ˜</h2>

            <h3>9.1 é…ç½®æ–‡ä»¶</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>æ–‡ä»¶</th>
                            <th>ç”¨é€”</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>config_default.yaml</code></td>
                            <td>é»˜è®¤é…ç½®ï¼ˆå°æ•°æ®é›†ï¼‰</td>
                        </tr>
                        <tr>
                            <td><code>config_large.yaml</code></td>
                            <td>å¤§è§„æ¨¡è®­ç»ƒé…ç½®</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h3>9.2 å‘½ä»¤è¡Œå‚æ•°</h3>
            <pre><code>python train.py \
    --mode pretrain|sft|rl \     <span class="comment"># è®­ç»ƒæ¨¡å¼</span>
    --dataset_scale small|large \ <span class="comment"># æ•°æ®é›†è§„æ¨¡</span>
    --config config.yaml \        <span class="comment"># é…ç½®æ–‡ä»¶</span>
    --checkpoint path/to/ckpt \   <span class="comment"># åŠ è½½æ£€æŸ¥ç‚¹</span>
    --device auto|cuda|mps|cpu \  <span class="comment"># è®¾å¤‡</span>
    --test                        <span class="comment"># å¿«é€Ÿæµ‹è¯•æ¨¡å¼</span></code></pre>

            <h3>9.3 å…³é”®é…ç½®é¡¹</h3>
            <pre><code><span class="keyword">model:</span>
  hidden_size: <span class="number">512</span>           <span class="comment"># æ¨¡å‹ç»´åº¦</span>
  num_hidden_layers: <span class="number">6</span>       <span class="comment"># Transformer å±‚æ•°</span>
  num_attention_heads: <span class="number">8</span>     <span class="comment"># æ³¨æ„åŠ›å¤´æ•°</span>
  
  <span class="keyword">moe:</span>
    enabled: <span class="keyword">true</span>
    num_experts: <span class="number">16</span>          <span class="comment"># ä¸“å®¶æ•°é‡</span>
    num_experts_per_tok: <span class="number">2</span>   <span class="comment"># æ¯ token æ¿€æ´»ä¸“å®¶æ•°</span>
    
  <span class="keyword">mtp:</span>
    enabled: <span class="keyword">true</span>
    num_predict_tokens: <span class="number">2</span>    <span class="comment"># é¢å¤–é¢„æµ‹ token æ•°</span>

<span class="keyword">pretraining:</span>
  batch_size: <span class="number">16</span>
  learning_rate: <span class="number">3e-4</span>
  max_steps: <span class="number">5000</span>

<span class="keyword">sft:</span>
  batch_size: <span class="number">8</span>
  learning_rate: <span class="number">2e-5</span>

<span class="keyword">rl:</span>
  algorithm: <span class="string">"grpo"</span>          <span class="comment"># grpo, ppo, dpo</span>
  group_size: <span class="number">4</span>
  kl_coef: <span class="number">0.1</span></code></pre>
        </section>

        <!-- Section 10: ç›‘æ§ä¸å¯è§†åŒ– -->
        <section class="section" id="section-10">
            <h2>10. ç›‘æ§ä¸å¯è§†åŒ–</h2>

            <h3>10.1 TensorBoard</h3>
            <pre><code><span class="comment"># å¯åŠ¨ TensorBoard</span>
./run.sh tensorboard

<span class="comment"># æˆ–æ‰‹åŠ¨å¯åŠ¨</span>
tensorboard --logdir=runs --port=6006</code></pre>

            <h3>10.2 å¯è§†åŒ–å†…å®¹</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ç±»åˆ«</th>
                            <th>å†…å®¹</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Loss</strong></td>
                            <td>train_loss, val_loss, perplexity</td>
                        </tr>
                        <tr>
                            <td><strong>Learning</strong></td>
                            <td>learning_rate, grad_norm</td>
                        </tr>
                        <tr>
                            <td><strong>Speed</strong></td>
                            <td>tokens/sec, samples/sec, steps/sec</td>
                        </tr>
                        <tr>
                            <td><strong>Attention</strong></td>
                            <td>æ³¨æ„åŠ›æƒé‡çƒ­åŠ›å›¾</td>
                        </tr>
                        <tr>
                            <td><strong>MoE</strong></td>
                            <td>ä¸“å®¶ä½¿ç”¨åˆ†å¸ƒ, routing entropy</td>
                        </tr>
                        <tr>
                            <td><strong>Generation</strong></td>
                            <td>ç”Ÿæˆæ–‡æœ¬æ ·æœ¬</td>
                        </tr>
                        <tr>
                            <td><strong>RL</strong></td>
                            <td>reward, kl_divergence, policy_loss</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h3>10.3 è®­ç»ƒæ—¥å¿—ç¤ºä¾‹</h3>
            <pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step:    100/5000 [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘]  2.0%             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Loss:   6.2345  (smoothed:   6.3012)                                 â”‚
â”‚ LR: 2.85e-04  Grad norm:   0.8721                                    â”‚
â”‚ Epoch: 1                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Speed:    12543 tok/s   98.2 samples/s   6.14 steps/s                â”‚
â”‚ Time:      16.3s  ETA:    13.1m                                      â”‚
â”‚ Tokens:      203,776                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        </section>
    </main>

    <footer class="footer">
        <h3>ğŸ“š å‚è€ƒèµ„æ–™</h3>
        <div class="links">
            <a href="https://arxiv.org/abs/2405.04434" target="_blank">DeepSeek-V2 Paper</a>
            <a href="https://arxiv.org/abs/2412.19437" target="_blank">DeepSeek-V3 Technical Report</a>
            <a href="https://arxiv.org/abs/1706.03762" target="_blank">Attention Is All You Need</a>
            <a href="https://arxiv.org/abs/2104.09864" target="_blank">RoFormer: Rotary Position Embedding</a>
            <a href="https://arxiv.org/abs/1707.06347" target="_blank">Proximal Policy Optimization</a>
            <a href="https://arxiv.org/abs/2305.18290" target="_blank">Direct Preference Optimization</a>
        </div>
        <p style="margin-top: 30px; opacity: 0.7;">DeepSeek V3 å®Œæ•´è®­ç»ƒæŒ‡å— Â© 2025</p>
    </footer>

    <button class="scroll-top" onclick="scrollToTop()" id="scrollTop">â†‘</button>

    <script>
        // Toggle navigation on mobile
        function toggleNav() {
            const toc = document.getElementById('toc');
            toc.classList.toggle('collapsed');
        }

        // Scroll to top
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Show/hide scroll to top button
        window.addEventListener('scroll', function() {
            const scrollTop = document.getElementById('scrollTop');
            if (window.pageYOffset > 300) {
                scrollTop.classList.add('visible');
            } else {
                scrollTop.classList.remove('visible');
            }
        });

        // Smooth scroll for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function(e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });
        });
    </script>
</body>
</html>
